/*
	Copyright (c) 2004-2011, The Dojo Foundation All Rights Reserved.
	Available via Academic Free License >= 2.1 OR the modified BSD license.
	see: http://dojotoolkit.org/license for details
*/


if(!dojo._hasResource["sen.pages.dashboard"]){dojo._hasResource["sen.pages.dashboard"]=true;dojo.provide("sen.pages.dashboard");dojo.require("dojo.fx");dojo.require("dojo.NodeList-fx");dojo.require("dojo.NodeList-traverse");dojo.require("dojo.NodeList-manipulate");dojo.declare("sen.pages.dashboard",null,{connectedEvents:null,requestStatuses:null,urlSegments:null,inFlight:null,init:function(){this.connectedEvents={"dashboard":[],"comments":[]};this.inFlight={"dashboard":[],"comments":[]};this.requestStatuses=this.initRquestStatuses();this.urlSegments=this.initUrlSegments();this.initUi();this.initEvents();},initRquestStatuses:function(){var _1={"10":["viewrequest","accept","reject"],"20":["viewaction","cancel","collected","complete"],"30":"","40":"","50":"","60":""};return _1;},initUrlSegments:function(){var _2={"viewrequest":"<li><a href=\"/requests/--rId--\" class=\"dashboard-action-link\" id=\"request_--rId--\">view request</a></li>","viewaction":"<li><a href=\"/requests/--rId--\" class=\"dashboard-action-link\" id=\"request_--rId--\">view action</a></li>","cancel":"<li><a href=\"/requests/--rId--/cancel.json\" data-method=\"put\" class=\"dashboard-action-link\" id=\"cancel_button\" rel=\"nofollow\">cancel</a></li>","collected":"<li><a href=\"/requests/--rId--/collected.json\" data-method=\"put\" class=\"dashboard-action-link\" id=\"collected_button\" rel=\"nofollow\">collected</a></li>","complete":"<li><a href=\"/requests/--rId--/complete.json\" data-method=\"put\" class=\"dashboard-action-link\" id=\"complete_button\" rel=\"nofollow\">complete</a></li>"};return _2;},initUi:function(){dojo.query("form.new_comment input#comment_submit").forEach(function(_3){dojo.style(_3,"display","none");});},initEvents:function(){this.connectDashboardEvents();this.connectCommentEvents();},connectDashboardEvents:function(_4){var _5=_4!==undefined?_4+".dashboard-action-link":".dashboard-action-link";var _6=this;this.disconnectDashboardEvents(_4);dojo.query(_5).forEach(function(_7){var _8=dojo.connect(_7,"onclick",_6,function(e){_6.doLinkClick(_7,e);});_6.connectedEvents.dashboard.push(_8);});dojo.query("a.action-comments-show-hide").forEach(function(_9){var _a=dojo.connect(_9,"onclick",_6,"toggleActionComments");_6.connectedEvents.comments.push(_a);});},disconnectDashboardEvents:function(_b){dojo.forEach(this.connectedEvents.dashboard,dojo.disconnect);this.connectedEvents.dashboard=[];},connectCommentEvents:function(){var _c=this;dojo.query("form.new_comment").forEach(function(_d){var _e=dojo.connect(_d,"onsubmit",_c,"addComment");_c.connectedEvents.comments.push(_e);var _e=dojo.connect(_d,"onkeypress",_c,"addComment");_c.connectedEvents.comments.push(_e);});dojo.query("a.comments-show-hide").forEach(function(_f){var _10=dojo.connect(_f,"onclick",_c,"toggleComments");_c.connectedEvents.comments.push(_10);});dojo.query("form.new_comment textarea").forEach(function(_11){var _12=dojo.connect(_11,"onfocus",_c,"toggleCommentBoxHeight");_c.connectedEvents.comments.push(_12);});dojo.query("form.new_comment textarea").forEach(function(_13){var _14=dojo.connect(_13,"onblur",_c,"toggleCommentBoxHeight");_c.connectedEvents.comments.push(_14);});},disconnectCommentEvents:function(_15){dojo.forEach(this.connectedEvents.comments,dojo.disconnect);this.connectedEvents.comments=[];},toggleCommentBoxHeight:function(e){if(e.type=="blur"){this.commentBlur(e.target);}else{this.commentFocus(e.target);}},commentBlur:function(_16){dojo.animateProperty({node:_16,duration:200,properties:{height:{start:"30",end:"15"}}}).play();if(dojo.attr(_16,"value")==""){dojo.attr(_16,"value","Write a comment...");}dojo.removeClass(_16,"active-comment-box");},commentFocus:function(_17){dojo.animateProperty({node:_17,duration:200,properties:{height:{start:"15",end:"30"}}}).play();if(dojo.attr(_17,"value")=="Write a comment..."){dojo.attr(_17,"value","");}dojo.addClass(_17,"active-comment-box");},toggleComments:function(e){dojo.stopEvent(e);var _18=this,_19=new dojo.NodeList(e.target);_19.parents(".sidebar-box").query("ul.comment-list").forEach(function(_1a){dojo.toggleClass(_1a,"comment-list-hidden");});},toggleActionComments:function(e){dojo.stopEvent(e);var _1b=this,_1c=new dojo.NodeList(e.target);_1c.parents("div.inner-content").query("ul.comment-list").forEach(function(_1d){dojo.toggleClass(_1d,"comment-list-hidden");});},addComment:function(e){if(dojo.getNodeProp(e.target,"tagName").toLowerCase()!=="form"){if(e.keyCode==dojo.keys.ENTER&&e.shiftKey==false){dojo.stopEvent(e);var nl=new dojo.NodeList(e.target),_1e=nl.parents("form").attr("action"),_1f=nl.parents("form");}else{if(e.keyCode==dojo.keys.ESCAPE){dojo.attr(e.target,"value","");e.target.blur();this.commentBlur(e.target);return;}else{return;}}}else{dojo.stopEvent(e);var _1e=dojo.attr(e.target,"action"),_1f=new dojo.NodeList(e.target);}var _20=this,_21=_1f.query(".new-comment-commentable-id").first().attr("value"),_22=_1f.query(".new-comment-text").first().attr("value");if(this.inFlight.comments[_21]!==true&&_22!=""){dojo.style(e.target,"display","none");_1f.before("<div class=\"loader\"></div>");this.inFlight.comments[_21]=true;dojo.xhrPost({url:_1e,handleAs:"json",content:{"comment[commentable_id]":_21,"comment[commentable_type]":_1f.query(".new-comment-commentable-type").first().attr("value"),"comment[comment]":_22,"authenticity_token":dojo.global.AUTH_TOKEN,"utf8":"âœ“"},load:function(_23){if(_23.success&&_23.success==false){}else{var _24=String(_23.comment_html).replace(/\"clearfix\"/,"\"clearfix new-comment\" style=\"opacity:0;\"");_1f.parents(".comment-list").children("li.no-bg").before(_24);_1f.parents(".comment-list").children("li.new-comment").fadeIn({auto:true,duration:800});var _25=_1f.parents("li.sidebar-box").query("a.comments-show-hide").first(),_26=_1f.parents("li.sidebar-box").query("a.comments-show-hide").first().attr("innerHTML"),_27=/([0-9]+)/g,_28=String(_26).match(_27);var _29=String(_26).replace(_27,parseInt(_28)+1);_1f.parents("li.sidebar-box").query("a.comments-show-hide").first().attr("innerHTML",_29);_1f.query("textarea").attr("value","");dojo.style(e.target,"display",null);_1f.parent().query("div.loader").remove();_20.inFlight.comments[_21]=false;}},error:function(err,_2a){console.error("Oops! Something went wrong.");dojo.style(e.target,"display",null);_1f.parent().query("div.loader").remove();_20.inFlight.comments[_21]=false;}});}return;},doLinkClick:function(_2b,e){dojo.stopEvent(e);var _2c=dojo.attr(e.target,"href"),_2d=this,_2e=new dojo.NodeList(e.target),_2f=_2e.parents("li.content-box").children("a").attr("href"),_30=String(_2f).replace("/requests/","");if(this.inFlight.dashboard[_30]!==true){var _31=_2e.parents("div.action ul");_31.forEach(function(_32){dojo.style(_32,"display","none");});_31.before("<div class=\"loader\"></div>");this.inFlight.dashboard[_30]=true;dojo.xhrPut({url:_2c,handleAs:"json",content:{"authenticity_token":dojo.global.AUTH_TOKEN},load:function(_33){if(_33.success&&_33.success==false){}else{var _34=_33.activity_html,_35=_33.request_html;var _36=_2e.parents("li.content-box"),_37=_36.prev(),_38=dojo.query("ul.dashboard-recent-activity").children().first();if(_37.length===0){_37=_36.parent();_36.remove();if(_35!==null){_37.forEach(function(_39){dojo.place("<li class=\"content-box clearfix\">"+_35+"</li>",_39,"first");});}if(_37.children("li").length==0){_37.parents("div.content-box-holder").forEach(function(_3a){dojo.style(_3a,"display","none");});}}else{_36.remove();if(_35!==null){_37.after("<li class=\"content-box clearfix\">"+_35+"</li>");}if(_37.parent().children("li").length==0){_37.parents("div.content-box-holder").forEach(function(_3b){dojo.style(_3b,"display","none");});}}_38.after(_34);_2d.connectDashboardEvents();_2d.updateMetrics(_33);_31.forEach(function(_3c){dojo.style(_3c,"display",null);});_31.parent().query("div.loader").remove();_2d.inFlight.dashboard[_30]=false;}},error:function(err,_3d){console.error("Oops! Something went wrong.");_31.forEach(function(_3e){dojo.style(_3e,"display",null);});_31.parent().query("div.loader").remove();_2d.inFlight.dashboard[_30]=false;}});}},updateMetrics:function(_3f){if(_3f.activity_level){var _40=dojo.query("li.activity-level a");_40.attr("innerHTML",_3f.activity_level);}if(_3f.gift_actions){var _41=dojo.query("li.giftactions a");_41.attr("innerHTML",_3f.gift_actions);}if(_3f.people_helped){var _42=dojo.query("li.people-helped a");_42.attr("innerHTML",_3f.people_helped);}},unload:function(){this.disconnectDashboardEvents();this.disconnectCommentEvents();}});}