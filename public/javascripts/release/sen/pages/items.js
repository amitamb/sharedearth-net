/*
	Copyright (c) 2004-2011, The Dojo Foundation All Rights Reserved.
	Available via Academic Free License >= 2.1 OR the modified BSD license.
	see: http://dojotoolkit.org/license for details
*/


if(!dojo._hasResource["sen.pages.items"]){dojo._hasResource["sen.pages.items"]=true;dojo.provide("sen.pages.items");dojo.require("dojo.fx");dojo.require("dojo.NodeList-fx");dojo.require("dojo.NodeList-traverse");dojo.require("dojo.NodeList-manipulate");dojo.declare("sen.pages.items",null,{connectedEvents:null,inFlight:null,init:function(){this.connectedEvents={"comments":[],"item":[]};this.inFlight={"comments":[]};this.initUi();this.initEvents();},initUi:function(){dojo.query("form.new_comment input#comment_submit").forEach(function(_1){dojo.style(_1,"display","none");});dojo.query("#item_description").forEach(function(_2){if(dojo.attr(_2,"value")==""){dojo.attr(_2,"value",dojo.attr(_2,"default_description"));}else{dojo.addClass(_2,"active");}});},initEvents:function(){this.connectItemEvents();this.connectCommentEvents();},connectItemEvents:function(){var _3=this;dojo.query("#item_description").forEach(function(_4){var _5=dojo.connect(_4,"onfocus",_3,"toggleItemDescription");_3.connectedEvents.item.push(_5);});dojo.query("#item_description").forEach(function(_6){var _7=dojo.connect(_6,"onblur",_3,"toggleItemDescription");_3.connectedEvents.item.push(_7);});dojo.query("form.edit_item").forEach(function(_8){var _9=dojo.connect(_8,"onsubmit",_3,function(e){dojo.stopEvent(e);var _a=dojo.byId("item_description");if(dojo.attr(_a,"value")==dojo.attr(_a,"default_description")){dojo.attr(_a,"value","");}e.target.submit();});_3.connectedEvents.item.push(_9);});},disconnectItemEvents:function(_b){dojo.forEach(this.connectedEvents.item,dojo.disconnect);this.connectedEvents.item=[];},connectCommentEvents:function(){var _c=this;dojo.query("form.new_comment").forEach(function(_d){var _e=dojo.connect(_d,"onsubmit",_c,"addComment");_c.connectedEvents.comments.push(_e);var _e=dojo.connect(_d,"onkeypress",_c,"addComment");_c.connectedEvents.comments.push(_e);});dojo.query("a.comments-show-hide").forEach(function(_f){var _10=dojo.connect(_f,"onclick",_c,"toggleComments");_c.connectedEvents.comments.push(_10);});dojo.query("form.new_comment textarea").forEach(function(_11){if(dojo.attr(_11,"value")!="Write a comment..."){dojo.addClass(_11,"active-comment-box");}var _12=dojo.connect(_11,"onfocus",_c,"toggleCommentBoxHeight");_c.connectedEvents.comments.push(_12);});dojo.query("form.new_comment textarea").forEach(function(_13){var _14=dojo.connect(_13,"onblur",_c,"toggleCommentBoxHeight");_c.connectedEvents.comments.push(_14);});},disconnectCommentEvents:function(_15){dojo.forEach(this.connectedEvents.comments,dojo.disconnect);this.connectedEvents.comments=[];},toggleItemDescription:function(e){var _16=e.target;if(e.type=="blur"){if(dojo.attr(_16,"value")==""){dojo.attr(_16,"value",dojo.attr(_16,"default_description"));dojo.removeClass(_16,"active");}}else{if(dojo.attr(_16,"value")==dojo.attr(_16,"default_description")){dojo.attr(_16,"value","");}dojo.addClass(_16,"active");}},toggleCommentBoxHeight:function(e){if(e.type=="blur"){this.commentBlur(e.target);}else{this.commentFocus(e.target);}},commentBlur:function(_17){dojo.animateProperty({node:_17,duration:200,properties:{height:{start:"30",end:"15"}}}).play();if(dojo.attr(_17,"value")==""){dojo.attr(_17,"value","Write a comment...");dojo.removeClass(_17,"active-comment-box");}},commentFocus:function(_18){dojo.animateProperty({node:_18,duration:200,properties:{height:{start:"15",end:"30"}}}).play();if(dojo.attr(_18,"value")=="Write a comment..."){dojo.attr(_18,"value","");}dojo.addClass(_18,"active-comment-box");},toggleComments:function(e){dojo.stopEvent(e);var _19=this,_1a=new dojo.NodeList(e.target);if(_1a.parents(".sidebar-box").query("ul.comment-list").length>0){_1a.parents(".sidebar-box").query("ul.comment-list").forEach(function(_1b){dojo.toggleClass(_1b,"comment-list-hidden");});}else{_1a.parents(".sidebar-box").next().query("ul.comment-list").forEach(function(_1c){dojo.toggleClass(_1c,"comment-list-hidden");});}},addComment:function(e){if(dojo.getNodeProp(e.target,"tagName").toLowerCase()!=="form"){if(e.keyCode==dojo.keys.ENTER&&e.shiftKey==false){dojo.stopEvent(e);var nl=new dojo.NodeList(e.target),_1d=nl.parents("form").attr("action"),_1e=nl.parents("form");}else{if(e.keyCode==dojo.keys.ESCAPE){dojo.attr(e.target,"value","");e.target.blur();this.commentBlur(e.target);return;}else{return;}}}else{dojo.stopEvent(e);var _1d=dojo.attr(e.target,"action"),_1e=new dojo.NodeList(e.target);}var _1f=this,_20=_1e.query(".new-comment-commentable-id").first().attr("value"),_21=_1e.query(".new-comment-text").first().attr("value");if(this.inFlight.comments[_20]!==true&&_21!=""){dojo.style(e.target,"display","none");_1e.before("<div class=\"loader\"></div>");this.inFlight.comments[_20]=true;dojo.xhrPost({url:_1d,handleAs:"json",content:{"comment[commentable_id]":_20,"comment[commentable_type]":_1e.query(".new-comment-commentable-type").first().attr("value"),"comment[comment]":_21,"authenticity_token":dojo.global.AUTH_TOKEN,"utf8":"âœ“"},load:function(_22){if(_22.success&&_22.success==false){}else{var _23=String(_22.comment_html).replace(/\"clearfix\"/,"\"clearfix new-comment\" style=\"opacity:0;\"");_1e.parents(".comment-list").children("li.no-bg").before(_23);_1e.parents(".comment-list").children("li.new-comment").fadeIn({auto:true,duration:800});var _24=_1e.parents("div.inner-content").prev().query("a.comments-show-hide").first(),_25=_24.attr("innerHTML");regExp=/([0-9]+)/g,currentCount=String(_25).match(regExp);var _26=String(_25).replace(regExp,parseInt(currentCount)+1);_24.attr("innerHTML",_26);_1e.query("textarea").attr("value","");dojo.style(e.target,"display",null);_1e.parent().query("div.loader").remove();_1f.inFlight.comments[_20]=false;}},error:function(err,_27){alert("Oops! Something went wrong.");dojo.style(e.target,"display",null);_1e.parent().query("div.loader").remove();_1f.inFlight.comments[_20]=false;}});}return;},unload:function(){this.disconnectCommentEvents();this.disconnectItemEvents();}});}