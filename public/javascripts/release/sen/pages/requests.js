/*
	Copyright (c) 2004-2011, The Dojo Foundation All Rights Reserved.
	Available via Academic Free License >= 2.1 OR the modified BSD license.
	see: http://dojotoolkit.org/license for details
*/


if(!dojo._hasResource["sen.pages.requests"]){dojo._hasResource["sen.pages.requests"]=true;dojo.provide("sen.pages.requests");dojo.require("dojo.fx");dojo.require("dojo.NodeList-fx");dojo.require("dojo.NodeList-traverse");dojo.require("dojo.NodeList-manipulate");dojo.declare("sen.pages.requests",null,{connectedEvents:null,inFlight:null,init:function(){this.connectedEvents={"comments":[]};this.inFlight={"comments":[]};this.initUi();this.initEvents();},initUi:function(){dojo.query("form.new_comment input#comment_submit").forEach(function(_1){dojo.style(_1,"display","none");});},initEvents:function(){this.connectCommentEvents();},connectCommentEvents:function(){var _2=this;dojo.query("form.new_comment").forEach(function(_3){var _4=dojo.connect(_3,"onsubmit",_2,"addComment");_2.connectedEvents.comments.push(_4);var _4=dojo.connect(_3,"onkeypress",_2,"addComment");_2.connectedEvents.comments.push(_4);});dojo.query("a.comments-show-hide").forEach(function(_5){var _6=dojo.connect(_5,"onclick",_2,"toggleComments");_2.connectedEvents.comments.push(_6);});dojo.query("#content form.new_comment textarea").forEach(function(_7){if(dojo.attr(_7,"value")!="Discuss"){dojo.addClass(_7,"active-comment-box");}var _8=dojo.connect(_7,"onfocus",_2,"toggleDiscussBox");_2.connectedEvents.comments.push(_8);});dojo.query("#content form.new_comment textarea").forEach(function(_9){var _a=dojo.connect(_9,"onblur",_2,"toggleDiscussBox");_2.connectedEvents.comments.push(_a);});dojo.query("#sidebar form.new_comment textarea").forEach(function(_b){if(dojo.attr(_b,"value")!="Write a comment..."){dojo.addClass(_b,"active-comment-box");}var _c=dojo.connect(_b,"onfocus",_2,"toggleCommentBoxHeight");_2.connectedEvents.comments.push(_c);});dojo.query("#sidebar form.new_comment textarea").forEach(function(_d){var _e=dojo.connect(_d,"onblur",_2,"toggleCommentBoxHeight");_2.connectedEvents.comments.push(_e);});},disconnectCommentEvents:function(_f){dojo.forEach(this.connectedEvents.comments,dojo.disconnect);this.connectedEvents.comments=[];},toggleDiscussBox:function(e){var _10=e.target;if(e.type=="blur"){dojo.animateProperty({node:_10,duration:200,properties:{height:{start:"30",end:"15"}}}).play();if(dojo.attr(_10,"value")==""){dojo.attr(_10,"value","Discuss");dojo.removeClass(_10,"active-comment-box");}}else{dojo.animateProperty({node:_10,duration:200,properties:{height:{start:"15",end:"30"}}}).play();if(dojo.attr(_10,"value")=="Discuss"){dojo.attr(_10,"value","");}dojo.addClass(_10,"active-comment-box");}},toggleCommentBoxHeight:function(e){if(e.type=="blur"){this.commentBlur(e.target);}else{this.commentFocus(e.target);}},commentBlur:function(_11){dojo.animateProperty({node:_11,duration:200,properties:{height:{start:"30",end:"15"}}}).play();if(dojo.attr(_11,"value")==""){dojo.attr(_11,"value","Write a comment...");dojo.removeClass(_11,"active-comment-box");}},commentFocus:function(_12){dojo.animateProperty({node:_12,duration:200,properties:{height:{start:"15",end:"30"}}}).play();if(dojo.attr(_12,"value")=="Write a comment..."){dojo.attr(_12,"value","");}dojo.addClass(_12,"active-comment-box");},toggleComments:function(e){dojo.stopEvent(e);var _13=this,_14=new dojo.NodeList(e.target);if(_14.parents(".sidebar-box").query("ul.comment-list").length>0){_14.parents(".sidebar-box").query("ul.comment-list").forEach(function(_15){dojo.toggleClass(_15,"comment-list-hidden");});}else{_14.parents(".sidebar-box").next().query("ul.comment-list").forEach(function(_16){dojo.toggleClass(_16,"comment-list-hidden");});}},addComment:function(e){if(dojo.getNodeProp(e.target,"tagName").toLowerCase()!=="form"){if(e.keyCode==dojo.keys.ENTER&&e.shiftKey==false){dojo.stopEvent(e);var nl=new dojo.NodeList(e.target),_17=nl.parents("form").attr("action"),_18=nl.parents("form");}else{if(e.keyCode==dojo.keys.ESCAPE){dojo.attr(e.target,"value","");e.target.blur();this.commentBlur(e.target);return;}else{return;}}}else{dojo.stopEvent(e);var _17=dojo.attr(e.target,"action"),_18=new dojo.NodeList(e.target);}var _19=this,_1a=_18.query(".new-comment-commentable-id").first().attr("value"),_1b=_18.query(".new-comment-text").first().attr("value");if(this.inFlight.comments[_1a]!==true&&_1b!=""){dojo.style(e.target,"display","none");_18.before("<div class=\"loader\"></div>");this.inFlight.comments[_1a]=true;dojo.xhrPost({url:_17,handleAs:"json",content:{"comment[commentable_id]":_1a,"comment[commentable_type]":_18.query(".new-comment-commentable-type").first().attr("value"),"comment[comment]":_1b,"authenticity_token":dojo.global.AUTH_TOKEN,"utf8":"âœ“"},load:function(_1c){if(_1c.success&&_1c.success==false){}else{var _1d=String(_1c.comment_html).replace(/\"clearfix\"/,"\"clearfix new-comment\" style=\"opacity:0;\"");if(_18.parents("div.content-box-holder").next().query(".comment-list").length>0){if(_18.parents("div.content-box-holder").next().query(".comment-list").children("li").length>0){_18.parents("div.content-box-holder").next().query(".comment-list").children("li").first().before(_1d);}else{_18.parents("div.content-box-holder").next().query(".comment-list").append(_1d);}_18.parents("div.content-box-holder").next().query(".comment-list").children("li.new-comment").fadeIn({auto:true,duration:800});}else{if(_18.parents(".comment-list").children("li").first().query("textarea").length>0){var _1e=true;_18.parents(".comment-list").children("li").first().next().forEach(function(_1f){if(dojo.hasClass(_1f,"even")){_1e=false;}});_18.parents(".comment-list").children("li").first().after(_1d);if(_1e===true){_18.parents(".comment-list").children("li.new-comment").forEach(function(_20){dojo.addClass(_20,"even");});}_18.parents(".comment-list").children("li.new-comment").fadeIn({auto:true,duration:800});}else{_18.parents(".comment-list").children("li.no-bg").before(_1d);_18.parents(".comment-list").children("li.new-comment").fadeIn({auto:true,duration:800});}}var _21=_18.parents("div.inner-content").prev().query("a.comments-show-hide").first(),_22=_21.attr("innerHTML");regExp=/([0-9]+)/g,currentCount=String(_22).match(regExp);var _23=String(_22).replace(regExp,parseInt(currentCount)+1);_21.attr("innerHTML",_23);_18.query("textarea").attr("value","");dojo.style(e.target,"display",null);_18.parent().query("div.loader").remove();_19.inFlight.comments[_1a]=false;}},error:function(err,_24){alert("Oops! Something went wrong.");dojo.style(e.target,"display",null);_18.parent().query("div.loader").remove();_19.inFlight.comments[_1a]=false;}});}return;},unload:function(){this.disconnectCommentEvents();}});}